#!/bin/bash
set -e
filepath=$1
root=$(cljs-root $filepath)
if ! cljs-auto-status $filepath 2>/dev/null; then
    # TODO the first start with `auto=y cljs` always fails because target/nodejs/ hasnt compiled yet. wait for it?
    echo :auto-starting >&2
    cljs-make-proj $filepath
    cljs-update $filepath
    cd $root
    lein npm install
    nohup bash -c 'lein trampoline cljsbuild auto dev 2>&1 | tee >(grep --line-buffered "Successfully compiled" > compiled.log) > compiler.log 2>&1' >/dev/null &
    echo $! > cljs-auto.pid
fi
echo :auto-running $(cat $root/cljs-auto.pid) >&2
