#!/bin/bash
set -e
filepath=$1
root=$(cljs-root $filepath)
now=$(cljs-hash $filepath)
then=$(cat $root/hash 2>/dev/null || echo '')
if [ "$now" != "$then" ]; then
    echo :recompiling >&2
    cljs-update $filepath
    cd $root
    lein npm install >&2
    # because cljsbuild doesnt exit speedily after successful compilation, when it does, drop this
    lein cljsbuild once > compiler.log 2>&1 &
    tail -f compiler.log| while read line; do
        echo $line >&2
        if echo $line |grep 'Successfully compiled' >/dev/null 2>&1; then
            echo "$now" > hash
            kill $! >&2
            pkill -P $$ tail >&2
            exit 0
        fi
    done
else
    echo :precompiled >&2
fi
