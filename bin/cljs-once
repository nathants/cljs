#!/bin/bash
set -e
filepath=$1
root=$(cljs-root $filepath)
if [ "$(cljs-hash $filepath)" != "$(cat $root/hash 2>/dev/null || echo '')" ]; then
    echo recompiling...
    cljs-update $filepath
    cd $root
    lein npm install

    # because cljsbuild doesnt exit speedily after successful compilation, when it does, drop this
    lein cljsbuild once > $root/compiler.log 2>&1 &
    tail -f $root/compiler.log| while read line; do
        echo $line
        if echo $line |grep 'Successfully compiled' >/dev/null; then
            kill $!
            pkill -P $$ tail
            exit 0
        fi
    done
else
    echo using precompiled
fi
