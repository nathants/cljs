#!/bin/bash
set -e
filepath=$1
[ ! -z "$clean" ] && echo :cleaned >&2 && rm -rf "$(cljs-root $filepath)"
root=$(cljs-root $filepath)
echo :releasing >&2
cljs-make-proj $filepath
cljs-update $filepath
cd $root
# lein npm install >&2

# because cljsbuild doesnt exit speedily after successful compilation, when it does, drop this
lein cljsbuild once release > compiler.log 2>&1 &
echo :recompiling >&2
tail -f compiler.log| while read line; do
    echo $line >&2
    if echo $line |grep 'Successfully compiled' >/dev/null 2>&1; then
        echo "$now" > hash
        kill -13 $! >&2
        pkill --signal 13 -P $$ tail >&2
        exit 0
    fi
done

ls | grep -v -e out-release -e node_modules | xargs rm -rf
mv out-release/release.js* .
rm -rf out-release
