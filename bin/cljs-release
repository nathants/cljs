#!/bin/bash
set -euo pipefail
filepath=$1
[ ! -z "${clean:-}" ] && echo :cleaned >&2 && rm -rf "$(cljs-root $filepath)"
root=$(cljs-root $filepath)
echo :releasing >&2
cljs-make-proj $filepath
cljs-update $filepath
cd $root
rm -f package.json*
lein npm install >&2
lein npm init -f |sed '1,/^$/d' > package.json.tmp
mv package.json.tmp package.json
echo :recompiling >&2
lein cljsbuild once release
ls | grep -v -e out-release -e node_modules -e package.json | xargs rm -rf
mv out-release/release.js* .
rm -rf out-release
