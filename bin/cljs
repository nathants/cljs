#!/bin/bash
set -e
filepath=$1
root=$(cljs-root $filepath)
if ls $root/release.js >/dev/null 2>&1; then
    shift
    node $root/release.js "$@"
else
    echo :root $root/ >&2
    if ! cljs-auto-status $filepath 2>/dev/null && [ ! -z "$clean" ]; then
        echo :cleaned >&2
        rm -rf "$root"
    fi
    if [ ! -z "$auto" ]; then
        cljs-auto-start $filepath
    fi
    source_hash=$(cljs-hash $filepath)
    compiled_hash=$(cat $root/hash 2>/dev/null || echo '')
    if [ ! -z "$usecached" ] || [ "$source_hash" == "$compiled_hash" ]; then
        echo :cached >&2
    elif cljs-auto-status $filepath 2>/dev/null; then
        echo :cljs-auto >&2
        cljs-auto-wait "$@"
    else
        echo :cljs-once >&2
        cljs-once $filepath
    fi
    echo :stdout >&2
    shift
    node $root/dev.js "$@"
fi
